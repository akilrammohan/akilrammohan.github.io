---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// Fetch both Goodreads collections
const favoriteBooks = await getCollection('favoriteBooks');
const siteBooks = await getCollection('siteBooks');

// Create set of favorite book IDs to exclude from "other" section
const favoriteIds = new Set(favoriteBooks.map(book => book.data.book_id));

// Filter out favorites from site books, sort by rating descending
const otherSiteBooks = siteBooks
  .filter(book => !favoriteIds.has(book.data.book_id))
  .sort((a, b) => b.data.user_rating - a.data.user_rating);
---

<BaseLayout title="Bookshelf | Akil Rammohan" fullWidth={true}>
  <h1>Bookshelf</h1>

  <p class="intro">
    Books from my <a href="https://www.goodreads.com/user/show/109135301-akil-rammohan" target="_blank" rel="noopener noreferrer">Goodreads</a> library.
  </p>

  {favoriteBooks.length > 0 && (
    <section class="favorites-section">
      <h2>Favorites</h2>
      <div class="favorites-grid">
        {favoriteBooks.map(book => (
          <a href={book.data.link} target="_blank" rel="noopener noreferrer" class="favorite-cover-link">
            <img
              src={book.data.book_large_image_url || '/placeholder-cover.svg'}
              alt={`Cover of ${book.data.title}`}
              class="favorite-cover"
              loading="lazy"
            />
          </a>
        ))}
      </div>
    </section>
  )}

  {otherSiteBooks.length > 0 && (
    <section class="read-section">
      <h2>Other Books I've Read</h2>
      <p class="section-note">Like most people, I began reading way before I signed up for Goodreads. Due to that I had to remember back to add books from the past, so this list is likely incomplete. I also excluded series I read as a kid, like Harry Potter, Rick Riordan books, Hunger Games, etc. Ordered by rating descending.</p>
      <div class="read-grid">
        {otherSiteBooks.map(book => (
          <a href={book.data.link} target="_blank" rel="noopener noreferrer" class="read-cover-link">
            <img
              src={book.data.book_large_image_url || '/placeholder-cover.svg'}
              alt={`Cover of ${book.data.title}`}
              class="read-cover"
              loading="lazy"
            />
          </a>
        ))}
      </div>
    </section>
  )}

  {favoriteBooks.length === 0 && otherSiteBooks.length === 0 && (
    <p class="empty-state">No books found. Check back later!</p>
  )}
</BaseLayout>

<style>
  h1 {
    font-size: 2rem;
    font-weight: 400;
    margin-bottom: 1.5rem;
  }

  .intro {
    margin-bottom: 2rem;
  }

  h2 {
    font-size: 1.5rem;
    font-weight: 400;
    margin-bottom: 1.5rem;
  }

  /* === Favorites Section === */
  .favorites-section {
    margin-bottom: 3rem;
  }

  .favorites-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 2rem;
  }

  .favorite-cover-link {
    display: block;
  }

  .favorite-cover {
    width: 100%;
    aspect-ratio: 2/3;
    object-fit: cover;
    border-radius: 4px;
    transition: transform 0.2s ease;
  }

  .favorite-cover-link:hover .favorite-cover {
    transform: scale(1.03);
  }

  /* === Read Books Section === */
  .read-section {
    margin-bottom: 2rem;
  }

  .section-note {
    margin-bottom: 1.5rem;
  }

  .read-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1.5rem;
  }

  .read-cover-link {
    display: block;
  }

  .read-cover {
    width: 100%;
    aspect-ratio: 2/3;
    object-fit: cover;
    border-radius: 4px;
    transition: transform 0.2s ease;
  }

  .read-cover-link:hover .read-cover {
    transform: scale(1.03);
  }

  /* === Empty State === */
  .empty-state {
    color: var(--text-muted);
    font-style: italic;
  }

  /* === Responsive Design === */
  @media (max-width: 1024px) {
    .favorites-grid {
      grid-template-columns: repeat(3, 1fr);
    }

    .read-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (max-width: 768px) {
    .favorites-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .read-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 480px) {
    .read-grid {
      gap: 1rem;
    }
  }
</style>
